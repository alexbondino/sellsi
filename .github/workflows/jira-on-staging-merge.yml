name: 'üöÄ Crear Jira Ticket en Merge a Staging'

on:
  push:
    branches:
      - staging

jobs:
  create-jira-issue-on-merge:
    # Solo corre si el commit es un "Merge pull request ..."
    if: startsWith(github.event.head_commit.message, 'Merge pull request')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: üèóÔ∏è Construir payload
        id: build_payload
        shell: bash
        run: |
          PR_MERGE_MESSAGE="${GITHUB_EVENT_HEAD_COMMIT_MESSAGE:-${{ github.event.head_commit.message }}}"
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          COMMIT_SHA="${{ github.sha }}"
          STAGING_URL="http://staging-sellsi.vercel.app"

          SUMMARY="Deploy a STAGING - $REPO - $COMMIT_SHA"

          DESCRIPTION="Deploy autom√°tico a STAGING desde GitHub Actions.\n\nRepositorio: $REPO\nActor: $ACTOR\nCommit SHA: $COMMIT_SHA\n\nMensaje de merge:\n$PR_MERGE_MESSAGE\n\nStaging URL:\n$STAGING_URL"

          echo "summary=$SUMMARY" >> "$GITHUB_OUTPUT"

          {
            echo "description<<EOF"
            echo -e "$DESCRIPTION"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: üìù Crear Jira Issue v√≠a API (Deployments)
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: DEP
          SUMMARY: ${{ steps.build_payload.outputs.summary }}
          DESCRIPTION: ${{ steps.build_payload.outputs.description }}
        shell: bash
        run: |
          echo "Creando issue en Jira (proyecto $JIRA_PROJECT_KEY)..."

          # Construimos el JSON de forma segura con jq
          PAYLOAD=$(jq -n \
            --arg project "$JIRA_PROJECT_KEY" \
            --arg summary "$SUMMARY" \
            --arg desc "$DESCRIPTION" \
            '{
              fields: {
                project: { key: $project },
                summary: $summary,
                issuetype: { name: "Submit a request or incident" },
                description: $desc
              }
            }')

          echo "Payload a enviar:"
          echo "$PAYLOAD"

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            --data "$PAYLOAD" \
            "$JIRA_BASE_URL/rest/api/3/issue")

          HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)

          echo "HTTP status: $HTTP_STATUS"
          echo "Respuesta Jira:"
          echo "$HTTP_BODY"

          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "‚ùå Error creando issue en Jira"
            exit 1
          fi

          ISSUE_KEY=$(echo "$HTTP_BODY" | jq -r '.key // empty')
          if [ -n "$ISSUE_KEY" ]; then
            echo "‚úÖ Issue creado: $ISSUE_KEY"
            echo "üîó $JIRA_BASE_URL/browse/$ISSUE_KEY"
          fi
