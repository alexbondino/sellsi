name: ğŸš€ Crear Jira Ticket en Merge a Staging

on:
  push:
    branches:
      - staging

jobs:
  create-jira-issue-on-merge:
    # Solo corre si el commit es un "Merge pull request ..."
    if: startsWith(github.event.head_commit.message, 'Merge pull request')
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ—ï¸ Construir Contenido de Issue
        id: build_content
        run: |
          # ğŸ”§ CAMBIA ESTA URL POR TU STAGING REAL
          STAGING_URL="https://staging.sellsi.cl"

          # La descripciÃ³n se puede escribir con Wiki Markup de Jira
          DESCRIPTION_WIKI=$(cat <<EOF
          {panel:title=Detalles del Despliegue a Staging|borderStyle=dashed|borderColor=#ccc}
          *Repositorio*: {{github.repository}}
          *Actor (quien hizo el merge)*: {{github.actor}}
          *Commit SHA*: {{github.sha}}

          *Mensaje de merge*:
          bq. {{github.event.head_commit.message}}

          *URL Staging*:
          [{{STAGING_URL}|{{STAGING_URL}}]
          {panel}
          EOF
          )

          # Sustituir variables de shell
          DESCRIPTION_WIKI="${DESCRIPTION_WIKI//\{\{github.repository\}\}/${{ github.repository }}}"
          DESCRIPTION_WIKI="${DESCRIPTION_WIKI//\{\{github.actor\}\}/${{ github.actor }}}"
          DESCRIPTION_WIKI="${DESCRIPTION_WIKI//\{\{github.sha\}\}/${{ github.sha }}}"
          DESCRIPTION_WIKI="${DESCRIPTION_WIKI//\{\{STAGING_URL\}\}/$STAGING_URL}"
          DESCRIPTION_WIKI="${DESCRIPTION_WIKI//\{\{github.event.head_commit.message\}\}/${{ github.event.head_commit.message }}}"

          echo "summary=Deploy a STAGING - ${{ github.repository }} - ${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "description_wiki=$DESCRIPTION_WIKI" >> $GITHUB_OUTPUT

      - name: ğŸ“ Crear Jira Issue
        uses: agile-ts/jira-action@v2
        with:
          jira-base-url: ${{ secrets.JIRA_BASE_URL }}
          jira-api-token: ${{ secrets.JIRA_API_TOKEN }}
          jira-user-email: ${{ secrets.JIRA_EMAIL }}
          jira-project: ${{ secrets.JIRA_PROJECT_KEY }}
          jira-issue-type: Task # O el tipo que necesites (Bug, Story, etc.)
          jira-summary: ${{ steps.build_content.outputs.summary }}
          # Usamos 'jira-description-wiki' para que use el formato Wiki Markup
          jira-description-wiki: ${{ steps.build_content.outputs.description_wiki }}
