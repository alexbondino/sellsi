name: 'üöÄ Crear Jira Ticket en Merge a Staging'

on:
  push:
    branches:
      - staging

jobs:
  create-jira-issue-on-merge:
    # Solo corre si el commit es un "Merge pull request ..."
    if: startsWith(github.event.head_commit.message, 'Merge pull request')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: üîç Obtener descripci√≥n del Pull Request
        id: pr_data
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_MSG: ${{ github.event.head_commit.message }}
        run: |
          echo "Merge message: $MERGE_MSG"

          # Extraer n√∫mero de PR desde el mensaje "Merge pull request #123 ..."
          # Usar solo la primera l√≠nea del mensaje para evitar problemas con saltos de l√≠nea
          PR_NUMBER=$(echo "$MERGE_MSG" | head -n 1 | sed -n 's/.*pull request #\([0-9]\+\).*/\1/p')
          echo "PR_NUMBER extra√≠do: $PR_NUMBER"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

          if [ -z "$PR_NUMBER" ]; then
            echo "No se pudo extraer n√∫mero de PR, dejando descripci√≥n vac√≠a."
            {
              echo "pr_description<<EOF"
              echo ""
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
            echo "pr_title=" >> "$GITHUB_OUTPUT"
            echo "pr_author=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Llamar a la API de GitHub para obtener body, t√≠tulo y autor del PR
          PR_JSON=$(curl -sS \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER")

          PR_BODY=$(echo "$PR_JSON" | jq -r '.body // ""')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title // ""')
          PR_AUTHOR=$(echo "$PR_JSON" | jq -r '.user.login // ""')

          {
            echo "pr_description<<EOF"
            echo "$PR_BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "pr_title=$PR_TITLE" >> "$GITHUB_OUTPUT"
          echo "pr_author=$PR_AUTHOR" >> "$GITHUB_OUTPUT"
          echo "üìù PR Author: $PR_AUTHOR"

      - name: üó∫Ô∏è Mapear GitHub user a Jira Account ID
        id: map_user
        shell: bash
        env:
          PR_AUTHOR: ${{ steps.pr_data.outputs.pr_author }}
          # Mapeo de usuarios GitHub -> Jira Account IDs
          # Agrega m√°s usuarios seg√∫n sea necesario
          JIRA_USER_MAP: |
            alexbondino:${{ secrets.JIRA_ACCOUNT_DANIEL }}
            TheLichKing12:${{ secrets.JIRA_ACCOUNT_KLAUS }}
        run: |
          echo "Buscando Jira Account ID para: $PR_AUTHOR"

          # Buscar el accountId en el mapeo
          JIRA_REPORTER_ID=""
          while IFS=: read -r github_user jira_id; do
            if [ "$github_user" = "$PR_AUTHOR" ]; then
              JIRA_REPORTER_ID="$jira_id"
              break
            fi
          done <<< "$JIRA_USER_MAP"

          if [ -n "$JIRA_REPORTER_ID" ]; then
            echo "‚úÖ Usuario mapeado: $PR_AUTHOR -> $JIRA_REPORTER_ID"
          else
            echo "‚ö†Ô∏è Usuario $PR_AUTHOR no tiene mapeo a Jira, se usar√° assignee como reporter"
            JIRA_REPORTER_ID="${{ secrets.JIRA_ASSIGNEE_ID }}"
          fi

          echo "reporter_id=$JIRA_REPORTER_ID" >> "$GITHUB_OUTPUT"

      - name: üèóÔ∏è Construir payload
        id: build_payload
        shell: bash
        env:
          PR_DESCRIPTION: ${{ steps.pr_data.outputs.pr_description }}
          PR_TITLE: ${{ steps.pr_data.outputs.pr_title }}
        run: |
          REPO="${{ github.repository }}"
          STAGING_URL="http://staging-sellsi.vercel.app"

          # ‚úÖ Usar el t√≠tulo del PR como summary en Jira
          # Si por alguna raz√≥n viniera vac√≠o, cae al fallback anterior
          if [ -n "$PR_TITLE" ]; then
            SUMMARY="$PR_TITLE"
          else
            SUMMARY="Deploy a STAGING - $REPO - ${{ github.sha }}"
          fi

          DESCRIPTION="Descripci√≥n del Pull Request:\n$PR_DESCRIPTION\n\nStaging URL:\n$STAGING_URL"

          echo "summary=$SUMMARY" >> "$GITHUB_OUTPUT"

          {
            echo "description<<EOF"
            echo -e "$DESCRIPTION"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: üìù Crear Jira Issue v√≠a API (Deployments)
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: DEP
          JIRA_ASSIGNEE_ID: ${{ secrets.JIRA_ASSIGNEE_ID }}
          JIRA_REPORTER_ID: ${{ steps.map_user.outputs.reporter_id }}
          SUMMARY: ${{ steps.build_payload.outputs.summary }}
          DESCRIPTION: ${{ steps.build_payload.outputs.description }}
        shell: bash
        run: |
          echo "Creando issue en Jira (proyecto $JIRA_PROJECT_KEY)..."

          # PAYLOAD en formato Atlassian Document Format (ADF) para description
          PAYLOAD=$(jq -n \
            --arg project "$JIRA_PROJECT_KEY" \
            --arg summary "$SUMMARY" \
            --arg desc "$DESCRIPTION" \
            --arg assignee "$JIRA_ASSIGNEE_ID" \
            --arg reporter "$JIRA_REPORTER_ID" \
            '
              def to_adf($text):
                ($text | split("\n")) as $lines |
                [
                  $lines[] |
                  if . == "" then
                    empty
                  elif test("^\\* "; "m") then
                    {
                      type: "bulletList",
                      content: [
                        {
                          type: "listItem",
                          content: [
                            {
                              type: "paragraph",
                              content: [
                                { type: "text", text: (sub("^\\* "; "")) }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  elif test("^\\*\\*(.*)\\*\\*$") then
                    {
                      type: "paragraph",
                      content: [
                        {
                          type: "text",
                          text: (sub("^\\*\\*(.*)\\*\\*$"; "\\1")),
                          marks: [{ type: "strong" }]
                        }
                      ]
                    }
                  else
                    {
                      type: "paragraph",
                      content: [
                        { type: "text", text: . }
                      ]
                    }
                  end
                ]
              ;

              {
                fields: {
                  project: { key: $project },
                  summary: $summary,
                  issuetype: { name: "Submit a request or incident" },
                  description: {
                    type: "doc",
                    version: 1,
                    content: to_adf($desc)
                  },
                  assignee: (
                    if $assignee != "" then
                      { id: $assignee }
                    else
                      null
                    end
                  ),
                  reporter: (
                    if $reporter != "" then
                      { id: $reporter }
                    else
                      null
                    end
                  )
                }
              }
            ')

          echo "Payload a enviar:"
          echo "$PAYLOAD"

          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            --data "$PAYLOAD" \
            "$JIRA_BASE_URL/rest/api/3/issue")

          HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)

          echo "HTTP status: $HTTP_STATUS"
          echo "Respuesta Jira:"
          echo "$HTTP_BODY"

          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "‚ùå Error creando issue en Jira"
            exit 1
          fi

          ISSUE_KEY=$(echo "$HTTP_BODY" | jq -r '.key // empty')
          if [ -n "$ISSUE_KEY" ]; then
            echo "‚úÖ Issue creado: $ISSUE_KEY"
            echo "üîó $JIRA_BASE_URL/browse/$ISSUE_KEY"
          fi
