name: 'üõ°Ô∏è Proteger Main Branch'

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, edited]

jobs:
  validate-pr-to-main:
    runs-on: ubuntu-latest

    steps:
      - name: üîç Validar origen del PR
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          SOURCE_BRANCH: ${{ github.event.pull_request.head.ref }}
          BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
        run: |
          echo "üéØ Target branch: $BASE_BRANCH"
          echo "üìç Source branch: $SOURCE_BRANCH"
          echo "üìù PR Title: $PR_TITLE"

          # Verificar que el destino sea main
          if [ "$BASE_BRANCH" != "main" ]; then
            echo "‚úÖ Este PR no va a main, permitido"
            exit 0
          fi

          # Permitir merges desde staging
          if [ "$SOURCE_BRANCH" = "staging" ]; then
            echo "‚úÖ Merge permitido: staging ‚Üí main"
            exit 0
          fi

          # Permitir PRs que empiecen con "hotfix" (case insensitive)
          if echo "$PR_TITLE" | grep -iq "^hotfix"; then
            echo "‚úÖ Hotfix permitido: $PR_TITLE"
            exit 0
          fi

          # Bloquear cualquier otro caso
          echo "‚ùå ERROR: Solo se permiten merges a main desde:"
          echo "   1. La rama 'staging'"
          echo "   2. PRs con t√≠tulo que empiece con 'hotfix' o 'Hotfix'"
          echo ""
          echo "Tu PR viene de: $SOURCE_BRANCH"
          echo "T√≠tulo del PR: $PR_TITLE"
          exit 1
